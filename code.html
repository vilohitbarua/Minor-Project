<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced and Slow Learners - Minor Project</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f5f7fa;
      color: #333;
      text-align: center;
      padding: 50px 20px;
    }

    h1 {
      color: #2a4d69;
      font-size: 2em;
      margin-bottom: 10px;
    }

    h2 {
      color: #4b86b4;
      font-size: 1.2em;
      margin-bottom: 40px;
    }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .subject-card {
      background-color: #dbe9f4;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, background-color 0.3s ease;
    }

    .subject-card:hover {
      background-color: #b9d7ea;
      transform: translateY(-5px);
    }

    .subject-card h3 {
      margin-bottom: 15px;
      color: #2a4d69;
    }

    .excel-btn {
      display: inline-block;
      background-color: #4b86b4;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .excel-btn:hover {
      background-color: #2a4d69;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 20px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 1400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover,
    .close:focus {
      color: #000;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #4b86b4;
      padding-bottom: 10px;
    }

    .modal-header h2 {
      margin: 0;
      color: #2a4d69;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.85em;
    }

    .data-table thead {
      background-color: #4b86b4;
      color: white;
      position: sticky;
      top: 0;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    .data-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .data-table tbody tr:hover {
      background-color: #dbe9f4;
    }

    .advance-learner {
      background-color: #d4edda;
      color: #155724;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .average-learner {
      background-color: #fff3cd;
      color: #856404;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .slow-learner {
      background-color: #f8d7da;
      color: #721c24;
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-box {
      background-color: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4b86b4;
    }

    .stat-box h4 {
      color: #2a4d69;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-box p {
      font-size: 1.5em;
      color: #4b86b4;
      font-weight: bold;
    }

    footer {
      margin-top: 60px;
      font-size: 0.9em;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #4b86b4;
    }

    .error {
      color: #d32f2f;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Advanced and Slow Learners Analysis</h1>
  <h2>Minor Project - Class Performance in Different Subjects</h2>

  <div class="subject-grid">
    <div class="subject-card">
      <h3>Web Technologies (WT)</h3>
      <button class="excel-btn" onclick="loadData('WT', 'Web Technologies')">View Data</button>
    </div>
    <div class="subject-card">
      <h3>Essentials of Management (EOM)</h3>
      <button class="excel-btn" onclick="loadData('EOM', 'Essentials of Management')">View Data</button>
    </div>
    <div class="subject-card">
      <h3>Database Management System (DBMS)</h3>
      <button class="excel-btn" onclick="loadData('DBMS', 'Database Management System')">View Data</button>
    </div>
    <div class="subject-card">
      <h3>Information Technology & Programming Concepts (ITPC)</h3>
      <button class="excel-btn" onclick="loadData('ITPC', 'Information Technology & Programming Concepts')">View Data</button>
    </div>
    <div class="subject-card">
      <h3>Indian Knowledge System (IKS)</h3>
      <button class="excel-btn" onclick="loadData('IKS', 'Indian Knowledge System')">View Data</button>
    </div>
  </div>

  <!-- Modal for displaying data -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Subject Data</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div id="loadingSpinner" class="loading" style="display:none;">Loading data...</div>
      <div id="errorMessage" class="error" style="display:none;"></div>
      <div id="statsContainer" class="stats-container"></div>
      <div id="tableContainer"></div>
    </div>
  </div>

  <footer>
    ©️ 2025 | Prepared by [Vilohit] | BCA Minor Project
  </footer>

  <script>
    function loadData(filename, subjectName) {
      const modal = document.getElementById('dataModal');
      const loading = document.getElementById('loadingSpinner');
      const error = document.getElementById('errorMessage');
      const table = document.getElementById('tableContainer');
      const stats = document.getElementById('statsContainer');
      const title = document.getElementById('modalTitle');

      modal.style.display = 'block';
      title.textContent = subjectName + ' - Student Performance Data';
      loading.style.display = 'block';
      error.style.display = 'none';
      table.innerHTML = '';
      stats.innerHTML = '';

      // Try backend API first (Flask). If it fails, fall back to local CSV fetch (Live Server).
      const apiUrl = `/api/csv/${encodeURIComponent(filename)}`;
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error('API not available');
          return response.json();
        })
        .then(result => {
          loading.style.display = 'none';
          const data = { headers: result.headers, data: result.data };
          displayData(data, stats, table, filename);
        })
        .catch(apiErr => {
          // Fallback: try to fetch the CSV file directly (for Live Server or static hosting)
          const localUrl = `/static/data/${filename.toLowerCase()}.csv`;
          fetch(localUrl)
            .then(response => {
              if (!response.ok) throw new Error('Local file not found (' + response.status + ')');
              return response.text();
            })
            .then(csv => {
              loading.style.display = 'none';
              const data = parseCSV(csv);
              displayData(data, stats, table, filename);
            })
            .catch(localErr => {
              loading.style.display = 'none';
              error.style.display = 'block';
              error.textContent = 'Error loading file: ' + (apiErr.message || apiErr) + ' / ' + (localErr.message || localErr);
              console.error('API error:', apiErr);
              console.error('Local fetch error:', localErr);
            });
        });
    }

    // Simple CSV parser used for local fallback. Handles basic comma-separated CSVs.
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const dataRows = lines.slice(1);

      const data = dataRows.map(line => {
        // naive split; assumes no commas inside values
        const values = line.split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || '';
        });
        return row;
      }).filter(r => Object.keys(r).length > 0);

      return { headers, data };
    }

    function pickColumns(headers, rows) {
      // Try to pick columns: name, roll/id, total marks, learner category
      const headerCandidates = headers.map(h => h.toString().toLowerCase());
      const res = {
        name: null,
        roll: null,
        total: null,
        category: null,
        other: []
      };

      // find category by scanning values for keywords
      for (let i = 0; i < headers.length; i++) {
        const h = headers[i];
        const colValues = rows.map(r => (r[h] || '').toString().toLowerCase());
        if (!res.category && colValues.some(v => v.includes('advance learner') || v.includes('average learner') || v.includes('slow learner') || v.includes('a/s learner'))) {
          res.category = h;
        }
        if (!res.total && (h.toLowerCase().includes('total') || h.toLowerCase().includes('marks') || colValues.every(v => v === '' || !isNaN(parseFloat(v))))) {
          // ensure not the category column
          if (res.category !== h) res.total = h;
        }
        if (!res.name && (h.toLowerCase().includes('name') || colValues.some(v => /^[a-zA-Z ]+$/.test(v) && v.split(' ').length >= 2))) {
          res.name = h;
        }
        if (!res.roll && (h.toLowerCase().includes('roll') || h.toLowerCase().includes('roll number') || h.toLowerCase().includes('id') || colValues.some(v => /\d{2,}/.test(v)))) {
          res.roll = h;
        }
      }

      // fallback: pick first columns
      headers.forEach(h => {
        if (!res.name && h.toLowerCase().includes('name')) res.name = h;
        if (!res.roll && h.toLowerCase().includes('roll')) res.roll = h;
        if (!res.total && h.toLowerCase().includes('total')) res.total = h;
        if (!res.category && h.toLowerCase().includes('learner')) res.category = h;
      });

      // final fallback assignments
      if (!res.name) res.name = headers[0];
      if (!res.roll) res.roll = headers[1] || headers[0];
      if (!res.total) res.total = headers.find(h => h.toLowerCase().includes('total')) || headers[headers.length - 1];
      if (!res.category) res.category = headers.find(h => h.toLowerCase().includes('learner')) || headers[headers.length - 2];

      // collect others to display if needed
      headers.forEach(h => {
        if (h !== res.name && h !== res.roll && h !== res.total && h !== res.category) res.other.push(h);
      });

      return res;
    }

    function displayData(data, statsContainer, tableContainer, key) {
      // Calculate statistics (pass avg_marks from API response if available)
      const stats = calculateStatistics(data.data, data.avg_marks);
      displayStatistics(stats, statsContainer);

      // Update button/card with student count if key provided
      if (key) {
        const count = data.data.length;
        const btn = document.querySelector(`.excel-btn[onclick*="${key}"]`);
        if (btn) {
          // add small badge
          let badge = btn.querySelector('.count-badge');
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'count-badge';
            badge.style.marginLeft = '8px';
            badge.style.background = '#fff';
            badge.style.color = '#4b86b4';
            badge.style.padding = '2px 6px';
            badge.style.borderRadius = '12px';
            badge.style.fontSize = '0.8em';
            btn.appendChild(badge);
          }
          badge.textContent = count;
        }
      }

      // pick best columns to show
      const cols = pickColumns(data.headers, data.data);

      // Create and display table with selected columns
      const table = document.createElement('table');
      table.className = 'data-table';

      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const showHeaders = [cols.name, cols.roll, cols.total, cols.category];
      showHeaders.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.data.forEach(row => {
        if (Object.values(row).some(v => v !== '')) {
          const tr = document.createElement('tr');
          showHeaders.forEach(header => {
            const td = document.createElement('td');
            const value = row[header] || '';
            if (value.toString().includes('Advance Learner')) {
              td.innerHTML = `<span class="advance-learner">Advance Learner</span>`;
            } else if (value.toString().includes('Average Learner')) {
              td.innerHTML = `<span class="average-learner">Average Learner</span>`;
            } else if (value.toString().includes('Slow Learner')) {
              td.innerHTML = `<span class="slow-learner">Slow Learner</span>`;
            } else {
              td.textContent = value;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
      });

      table.appendChild(tbody);
      tableContainer.appendChild(table);
    }

    function calculateStatistics(data, avgMarks) {
      let advanceLearners = 0;
      let averageLearners = 0;
      let slowLearners = 0;
      let totalMarks = 0;
      let studentCount = 0;
      let minMarks = Infinity;
      let maxMarks = -Infinity;

      data.forEach(row => {
        // Count learner categories
        Object.values(row).forEach(value => {
          if (value.includes('Advance Learner')) {
            advanceLearners++;
            return;
          }
          if (value.includes('Average Learner')) {
            averageLearners++;
            return;
          }
          if (value.includes('Slow Learner')) {
            slowLearners++;
            return;
          }
        });

        // Get total marks and track min/max
        const totalMarksValue = row.total;
        if (totalMarksValue && !isNaN(parseFloat(totalMarksValue))) {
          const marks = parseFloat(totalMarksValue);
          totalMarks += marks;
          studentCount++;
          minMarks = Math.min(minMarks, marks);
          maxMarks = Math.max(maxMarks, marks);
        }
      });

      return {
        advanceLearners: advanceLearners,
        averageLearners: averageLearners,
        slowLearners: slowLearners,
        averageMarks: avgMarks || (studentCount > 0 ? (totalMarks / studentCount).toFixed(2) : 0),
        minMarks: minMarks === Infinity ? 0 : minMarks,
        maxMarks: maxMarks === -Infinity ? 0 : maxMarks
      };
    }

    function displayStatistics(stats, container) {
      const statsHTML = `
        <div class="stat-box">
          <h4>Advance Learners</h4>
          <p>${Math.round(stats.advanceLearners)}</p>
        </div>
        <div class="stat-box">
          <h4>Average Learners</h4>
          <p>${Math.round(stats.averageLearners)}</p>
        </div>
        <div class="stat-box">
          <h4>Slow Learners</h4>
          <p>${Math.round(stats.slowLearners)}</p>
        </div>
        <div class="stat-box">
          <h4>Average Marks</h4>
          <p>${stats.averageMarks}</p>
        </div>
        <div class="stat-box">
          <h4>Min Marks</h4>
          <p>${stats.minMarks}</p>
        </div>
        <div class="stat-box">
          <h4>Max Marks</h4>
          <p>${stats.maxMarks}</p>
        </div>
      `;
      container.innerHTML = statsHTML;
    }

    function closeModal() {
      document.getElementById('dataModal').style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('dataModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Fetch counts for each subject on page load and show badge on buttons
    function updateCountBadge(key, count, totalMarks) {
      const btn = document.querySelector(`.excel-btn[onclick*="${key}"]`);
      if (!btn) return;
      let badge = btn.querySelector('.count-badge');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'count-badge';
        badge.style.marginLeft = '8px';
        badge.style.background = '#fff';
        badge.style.color = '#4b86b4';
        badge.style.padding = '2px 6px';
        badge.style.borderRadius = '12px';
        badge.style.fontSize = '0.8em';
        btn.appendChild(badge);
      }
      // Display total marks on badge
      badge.textContent = totalMarks || count;
    }

    function loadCounts() {
      fetch('/api/counts')
        .then(res => {
          if (!res.ok) throw new Error('Counts API not available');
          return res.json();
        })
        .then(data => {
          Object.keys(data).forEach(key => {
            const info = data[key];
            if (info && typeof info.total_marks !== 'undefined') {
              updateCountBadge(key, info.total_students, info.total_marks);
            }
          });
        })
        .catch(err => {
          // silently ignore; badges will appear when a subject is opened
          console.warn('Could not load counts:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', loadCounts);
  </script>
</body>
</html>
